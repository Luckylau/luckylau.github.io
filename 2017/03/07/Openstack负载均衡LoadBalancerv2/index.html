<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="neutron," />








  <link rel="shortcut icon" type="image/x-icon" href="/logo.jpg?v=5.1.0" />






<meta name="description" content="​       最近研究了一下Openstack负载均衡，yum源和源码级别的安装都尝试成功了。网上有很多文章都是LoadBalancerv1，这个已经被放弃了。所以写一下自己是如何使用LoadBalancerv2。当然在介绍之前还是从负载均衡基础知识开始吧。（Mitaka版本的LoadBalancerv2）
负载均衡的概念和分类？​        负载均衡（Load Balancing）是将来访">
<meta property="og:type" content="article">
<meta property="og:title" content="Openstack 负载均衡 LoadBalancerv2">
<meta property="og:url" content="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/index.html">
<meta property="og:site_name" content="Luckylau's Blog">
<meta property="og:description" content="​       最近研究了一下Openstack负载均衡，yum源和源码级别的安装都尝试成功了。网上有很多文章都是LoadBalancerv1，这个已经被放弃了。所以写一下自己是如何使用LoadBalancerv2。当然在介绍之前还是从负载均衡基础知识开始吧。（Mitaka版本的LoadBalancerv2）
负载均衡的概念和分类？​        负载均衡（Load Balancing）是将来访">
<meta property="og:image" content="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/1.png">
<meta property="og:image" content="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/2.png">
<meta property="og:image" content="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/1.jpg">
<meta property="og:image" content="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/2.jpg">
<meta property="og:image" content="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/3.jpg">
<meta property="og:image" content="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/3.png">
<meta property="og:image" content="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/4.png">
<meta property="og:image" content="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/5.png">
<meta property="og:image" content="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/6.png">
<meta property="og:image" content="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/7.png">
<meta property="og:image" content="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/8.png">
<meta property="og:image" content="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/9.png">
<meta property="og:image" content="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/10.png">
<meta property="og:image" content="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/4.jpg">
<meta property="og:image" content="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/5.jpg">
<meta property="og:image" content="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/6.jpg">
<meta property="og:image" content="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/7.jpg">
<meta property="og:updated_time" content="2017-03-10T03:15:07.050Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Openstack 负载均衡 LoadBalancerv2">
<meta name="twitter:description" content="​       最近研究了一下Openstack负载均衡，yum源和源码级别的安装都尝试成功了。网上有很多文章都是LoadBalancerv1，这个已经被放弃了。所以写一下自己是如何使用LoadBalancerv2。当然在介绍之前还是从负载均衡基础知识开始吧。（Mitaka版本的LoadBalancerv2）
负载均衡的概念和分类？​        负载均衡（Load Balancing）是将来访">
<meta name="twitter:image" content="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/"/>





  <title> Openstack 负载均衡 LoadBalancerv2 | Luckylau's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Luckylau's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle">Keep Moving, Keep Learning</p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Luckylau">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/logo.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Luckylau's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Luckylau's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Openstack 负载均衡 LoadBalancerv2
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-03-07T15:50:16+08:00">
                2017-03-07
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/neutron/" itemprop="url" rel="index">
                    <span itemprop="name">neutron</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/03/07/Openstack负载均衡LoadBalancerv2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/03/07/Openstack负载均衡LoadBalancerv2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>​       最近研究了一下Openstack负载均衡，yum源和<a href="https://github.com/openstack/neutron-lbaas/tree/stable/mitaka" target="_blank" rel="external">源码</a>级别的安装都尝试成功了。网上有很多文章都是LoadBalancerv1，这个已经被放弃了。所以写一下自己是如何使用LoadBalancerv2。当然在介绍之前还是从负载均衡基础知识开始吧。（Mitaka版本的LoadBalancerv2）</p>
<h3 id="负载均衡的概念和分类？"><a href="#负载均衡的概念和分类？" class="headerlink" title="负载均衡的概念和分类？"></a>负载均衡的概念和分类？</h3><p>​        负载均衡（Load Balancing）是将来访的网络流量在运行相同应用的多个服务器之间进行分发的一种核心网络服务。它的功能由负载均衡器（load balancer）提供。负载均衡器可以是一个硬件设备，也可以由软件实现。它充当反向代理，在多个服务器之间分发网络或者应用流量。它常用来增加应用的访问容量（并发用户数）和可靠性，它也会通过降低服务器的负载来提高应用的总体性能。</p>
<a id="more"></a>
<p>负载均衡器的分类</p>
<p>负载均衡器一般可以分为两类：第4层负载均衡器和第7层负载均衡器。</p>
<p>第 4 层负载平衡器：基于网络和传输层协议（IP，TCP，FTP，UDP等）来均衡负载。</p>
<p><img src="/2017/03/07/Openstack负载均衡LoadBalancerv2/1.png" alt=""></p>
<p>第7层的负载均衡器：基于应用层协议比如 HTTP, SMTP, SNMP, FTP, Telnet 等均衡负载。比如对 HTTP 来说，第七层的负载均衡器能根据应用的特定数据比如 HTTP 头，cookies 或者应用消息中的数据来做进一步的请求分发。</p>
<p><img src="/2017/03/07/Openstack负载均衡LoadBalancerv2/2.png" alt=""></p>
<p>负载分发算法</p>
<p>​    两种类型的负载均衡器都能接收请求，然后根据特定的算法将请求分发到特定的服务器。一些行业标准的算法是：</p>
<p>​    轮询 (Round robin)：轮流分发到各个（活动）服务器<br>​    加权轮循 (Weighted round robin)：每个服务器有一定的加权（weight），轮询时考虑加权。<br>​    最少连接 (Least connections)：转发到有最少连接数的服务器<br>​    最少响应时间 (Least response time)：转发到响应时间最短的服务器</p>
<p>可靠性和可用性</p>
<p>​    负载均衡器通过监控应用的健康状态来确保可靠性和可用性，并且只转发请求到能及时做出响应的服务和应用。</p>
<p>Session persistence （会话保持）</p>
<p>​        用户(浏览器)在和服务端交互的时候，通常会在本地保存一些信息，而整个过程叫做一个会话(Session)并用唯一的Session ID进行标识。会话的概念不仅用于购物车这种常见情况，因为HTTP协议是无状态的，所以任何需要逻辑上下文的情形都必须使用会话机制，此外HTTP客户端也会额外缓存一些数据在本地，这样就可以减少请求提高性能了。如果负载均衡可能将这个会话的请求分配到不同的后台服务端上，这肯定是不合适的，必须通过多个backend共享这些数据，效率肯定会很低下，最简单的情况是保证会话一致性——相同的会话每次请求都会被分配到同一个backend上去。</p>
<p>​    会话保持表示在一个会话期间，转发一个用户的请求到同一个后端服务器。这对购物车或者付款类的请求非常重要。 常用的方法包括：</p>
<p>​    Source IP：相同来源的请求转发到同一个服务器<br>​    HTTP Cookie：该模式下，loadbalancer 为客户端的第一次连接生成 cookie，后续携带该 cookie 的请求会被某个 member 处理<br>​    APP Cookie：该模式下，依靠后端应用服务器生成的 cookie 决定被某个 member 处理</p>
<h3 id="负载均衡的实现方式？"><a href="#负载均衡的实现方式？" class="headerlink" title="负载均衡的实现方式？"></a>负载均衡的实现方式？</h3><p><strong>http重定向</strong></p>
<p>​       当http代理（比如浏览器）向web服务器请求某个URL后，web服务器可以通过http响应头信息中的Location标记来返回一个新的URL。这意味着HTTP代理需要继续请求这个新的URL，完成自动跳转。</p>
<p>缺陷：<br>1、吞吐率限制<br>​        主站点服务器的吞吐率平均分配到了被转移的服务器。现假设使用RR（Round Robin）调度策略，子服务器的最大吞吐率为1000reqs/s，那么主服务器的吞吐率要达到3000reqs/s才能完全发挥三台子服务器的作用，那么如果有100台子服务器，那么主服务器的吞吐率可想而知得有大？相反，如果主服务的最大吞吐率为6000reqs/s，那么平均分配到子服务器的吞吐率为2000reqs/s，而现子服务器的最大吞吐率为1000reqs/s，因此就得增加子服务器的数量，增加到6个才能满足。</p>
<p>2、重定向访问深度不同<br>​        有的重定向一个静态页面，有的重定向相比复杂的动态页面，那么实际服务器的负载差异是不可预料的，而主站服务器却一无所知。因此整站使用重定向方法做负载均衡不太好。</p>
<p>​        我们需要权衡转移请求的开销和处理实际请求的开销，前者相对于后者越小，那么重定向的意义就越大，例如下载。你可以去很多镜像下载网站试下，会发现基本下载都使用了Location做了重定向。</p>
<p><strong>DNS负载均衡</strong></p>
<p>​        DNS负责提供域名解析服务，当访问某个站点时，实际上首先需要通过该站点域名的DNS服务器来获取域名指向的IP地址，在这一过程中，DNS服务器完成了域名到IP地址的映射，同样，这样映射也可以是一对多的，这时候，DNS服务器便充当了负载均衡调度器，它就像http重定向转换策略一样，将用户的请求分散到多台服务器上，但是它的实现机制完全不同。</p>
<p>​        相比http重定向，基于DNS的负载均衡完全节省了所谓的主站点，或者说DNS服务器已经充当了主站点的职能。但不同的是，作为调度器，DNS服务器本身的性能几乎不用担心。因为DNS记录可以被用户浏览器或者互联网接入服务商的各级DNS服务器缓存，只有当缓存过期后才会重新向域名的DNS服务器请求解析。也说是DNS不存在http的吞吐率限制，理论上可以无限增加实际服务器的数量。</p>
<p>缺陷：<br>1、没有用户能直接看到DNS解析到了哪一台实际服务器，加服务器运维人员的调试带来了不便。<br>2、策略的局限性。例如你无法将HTTP请求的上下文引入到调度策略中，而在前面介绍的基于HTTP重定向的负载均衡系统中，调度器工作在HTTP层面，它可以充分理解HTTP请求后根据站点的应用逻辑来设计调度策略，比如根据请求不同的URL来进行合理的过滤和转移。<br>3、如果要根据实际服务器的实时负载差异来调整调度策略，这需要DNS服务器在每次解析操作时分析各服务器的健康状态，对于DNS服务器来说，这种自定义开发存在较高的门槛，更何况大多数站点只是使用第三方DNS服务。<br>4、DNS记录缓存，各级节点的DNS服务器不同程序的缓存会让你晕头转向。<br>5、基于以上几点，DNS服务器并不能很好地完成工作量均衡分配，最后，是否选择基于DNS的负载均衡方式完全取决于你的需要。</p>
<p><strong>反向代理负载均衡</strong></p>
<p>​       几乎所有主流的Web服务器都热衷于支持基于反向代理的负载均衡。它的核心工作就是转发HTTP请求。<br>相比前面的HTTP重定向和DNS解析，反向代理的调度器扮演的是用户和实际服务器中间人的角色：<br>1、任何对于实际服务器的HTTP请求都必须经过调度器<br>2、调度器必须等待实际服务器的HTTP响应，并将它反馈给用户（前两种方式不需要经过调度反馈，是实际服务器直接发送给用户）</p>
<p>特性：<br>1、调度策略丰富。例如可以为不同的实际服务器设置不同的权重，以达到能者多劳的效果。<br>2、对反向代理服务器的并发处理能力要求高，因为它工作在HTTP层面。<br>3、反向代理服务器进行转发操作本身是需要一定开销的，比如创建线程、与后端服务器建立TCP连接、接收后端服务器返回的处理结果、分析HTTP头部信息、用户空间和内核空间的频繁切换等，虽然这部分时间并不长，但是当后端服务器处理请求的时间非常短时，转发的开销就显得尤为突出。例如请求静态文件，更适合使用前面介绍的基于DNS的负载均衡方式。<br>4、反向代理服务器可以监控后端服务器，比如系统负载、响应时间、是否可用、TCP连接数、流量等，从而根据这些数据调整负载均衡的策略。<br>5、反射代理服务器可以让用户在一次会话周期内的所有请求始终转发到一台特定的后端服务器上（粘滞会话），这样的好处一是保持session的本地访问，二是防止后端服务器的动态内存缓存的资源浪费。</p>
<p><strong>IP层负载均衡LVS-NAT</strong></p>
<p>​      我们需要在HTTP层面以下实现负载均衡，这些负载均衡调度器的工作必须由Linux内核来完成，因为我们希望网络数据包在从内核缓冲区进入进程用户地址空间之前，尽早地被转发到其他实际服务器上。而且正因为可以将调度器工作在应用层之下，这些负载均衡系统可以支持更多的网络服务协议，比如ftp，smtp，dns，以及流媒体和VoIP等应用。</p>
<p>​       DNAT： 反向NAT，将实际服务器放置在内部网络，而作为网关的NAT服务器将来自用户端的数据包转发给内部网络的实际服务器(需要修改的是数据包的目标地址和端口)。比较著名的例子是LVS。NAT调度器的吞吐率很高是因为其在内核中进行请求转发的较低开销。</p>
<p>但是NAT服务器的带宽却成为了瓶颈。幸运的是，LVS提供了另一种负载均衡的方式，那就是直接路由。</p>
<p><strong>直接路由LVS-DR</strong></p>
<p>​        不同于NAT机制，直接路由的负载均衡调度器工作在数据链路层上，简单地说，它通过修改数据包的目标mac地址，将数据包转发到实际服务器上，并且重要的是，实际服务器的响应数据包将直接发送给客户端，不经过调度器。适用于视频网站（响应的数据包远远超过请求的数据包）。对于LVS-DR，一旦调度器失效，你可以马上将LVS-DR切换到DNS-RR模式</p>
<h3 id="常见的开源软件负载均衡器？"><a href="#常见的开源软件负载均衡器？" class="headerlink" title="常见的开源软件负载均衡器？"></a>常见的开源软件负载均衡器？</h3><p>​         负载均衡器 目前有2种，一种是通过硬件来进行进行，常见的硬件有比较昂贵的NetScaler、F5、Radware和Array等商用的负载均衡器，它的优点就是有专业的维护团队来对这些服务进行维护、缺点就是花销太大，所以对于规模较小的网络服务来说暂时还没有需要使用；另外一种就是类似于LVS/HAProxy、Nginx的基于Linux的开源免费的负载均衡软件策略,这些都是通过软件级别来实现，所以费用非常低廉。</p>
<p>Nginx、LVS及HAProxy是目前最常用的开源软件负载均衡器。</p>
<p><strong>LVS</strong></p>
<p>LVS：使用集群技术和Linux操作系统实现一个高性能、高可用的服务器，它具有很好的可伸缩性（Scalability)、可靠性（Reliability)和可管理性（Manageability)。</p>
<p>LVS的特点是：</p>
<p>1、抗负载能力强、是工作在网络4层之上仅作分发之用，没有流量的产生，这个特点也决定了它在负载均衡软件里的性能最强的；</p>
<p>2、配置性比较低，这是一个缺点也是一个优点，因为没有可太多配置的东西，所以并不需要太多接触，大大减少了人为出错的几率；</p>
<p>3、工作稳定，自身有完整的双机热备方案，如LVS+Keepalived和LVS+Heartbeat，不过我们在项目实施中用得最多的还是LVS/DR+Keepalived；</p>
<p>4、无流量，保证了均衡器IO的性能不会收到大流量的影响；</p>
<p>5、应用范围比较广，可以对所有应用做负载均衡；</p>
<p>6、软件本身不支持正则处理，不能做动静分离，这个就比较遗憾了；其实现在许多网站在这方面都有较强的需求，这个是Nginx/HAProxy+Keepalived的优势所在。</p>
<p>7、如果是网站应用比较庞大的话，实施LVS/DR+Keepalived起来就比较复杂了，特别后面有Windows Server应用的机器的话，如果实施及配置还有维护过程就比较复杂了，相对而言，Nginx/HAProxy+Keepalived就简单多了。</p>
<p><strong>Nginx</strong></p>
<p>Nginx的特点是：</p>
<p>1、工作在网络的7层之上，可以针对http应用做一些分流的策略，比如针对域名、目录结构，它的正则规则比HAProxy更为强大和灵活，这也是许多朋友喜欢它的原因之一；</p>
<p>2、Nginx对网络的依赖非常小，理论上能ping通就就能进行负载功能，这个也是它的优势所在；</p>
<p>3、Nginx安装和配置比较简单，测试起来比较方便；</p>
<p>4、也可以承担高的负载压力且稳定，一般能支撑超过几万次的并发量；</p>
<p>5、Nginx可以通过端口检测到服务器内部的故障，比如根据服务器处理网页返回的状态码、超时等等，并且会把返回错误的请求重新提交到另一个节点，不过其中缺点就是不支持url来检测；</p>
<p>6、Nginx仅能支持http和Email，这样就在适用范围上面小很多，这个它的弱势；</p>
<p>7、Nginx不仅仅是一款优秀的负载均衡器/反向代理软件，它同时也是功能强大的Web应用服务器。LNMP现在也是非常流行的web架构，大有和以前最流行的LAMP架构分庭抗争之势，在高流量的环境中也有很好的效果。</p>
<p>8、Nginx现在作为Web反向加速缓存越来越成熟了，很多朋友都已在生产环境下投入生产了，而且反映效果不错，速度比传统的Squid服务器更快，有兴趣的朋友可以考虑用其作为反向代理加速器。</p>
<p><strong>HAProxy</strong></p>
<p>HAProxy的特点是：</p>
<p>1、HAProxy是支持虚拟主机的，以前有朋友说这个不支持虚拟主机，我这里特此更正一下。</p>
<p>2、能够补充Nginx的一些缺点比如Session的保持，Cookie的引导等工作</p>
<p>3、支持url检测后端的服务器出问题的检测会有很好的帮助。</p>
<p>4、它跟LVS一样，本身仅仅就只是一款负载均衡软件；单纯从效率上来讲HAProxy更会比Nginx有更出色的负载均衡速度，在并发处理上也是优于Nginx的。</p>
<p>5、HAProxy可以对Mysql读进行负载均衡，对后端的MySQL节点进行检测和负载均衡，不过在后端的MySQL slaves数量超过10台时性能不如LVS，所以我向大家推荐LVS+Keepalived。</p>
<p>6、HAProxy的算法现在也越来越多了，具体有如下8种：</p>
<p>roundrobin，表示简单的轮询，这个不多说，这个是负载均衡基本都具备的；</p>
<p>static-rr，表示根据权重，建议关注；</p>
<p>leastconn，表示最少连接者先处理，建议关注；</p>
<p>source，表示根据请求源IP，这个跟Nginx的IP_hash机制类似，我们用其作为解决session问题的一种方法，建议关注；</p>
<p>ri，表示根据请求的URI；</p>
<p>rl_param，表示根据请求的URl参数’balance url_param’ requires an URL parameter name；</p>
<p>hdr(name)，表示根据HTTP请求头来锁定每一次HTTP请求；</p>
<p>rdp-cookie(name)，表示根据据cookie(name)来锁定并哈希每一次TCP请求。</p>
<h3 id="负载均衡部署模式？"><a href="#负载均衡部署模式？" class="headerlink" title="负载均衡部署模式？"></a>负载均衡部署模式？</h3><p>基本的负载均衡场景有3种：</p>
<p>Two-Arm (or sometimes called In-Line)（双臂）模式<br>One-Arm（单臂）模式<br>Direct Server Response模式</p>
<p><strong>Two-Arm (or sometimes called In-Line)（双臂）模式</strong></p>
<p>双臂模式有 switched mode（“bridge mode” or “transparent mode”） 和routed mode两种，routed mode要优于switched mode，实际生产环境也没有switched mode方式。</p>
<p><img src="/2017/03/07/Openstack负载均衡LoadBalancerv2/1.jpg" alt=""></p>
<p>​         对于routed mode模式来说，As you can agree, the Load-Balancer is also a router between the “Front End” and “Back End” networks. As such, he can simply do destination IP NAT in client request coming to the load-balanced virtual IP and forward the packet to one of the servers in server farm. During this proces, the destination physical server is chosen by the load-balancing algorithm.Return traffic is going back via the Load-Balancer and the source IP is again changed to the virtual load-balanced IP in the response to the Client.</p>
<p><strong>One-Arm（单臂）模式</strong></p>
<p>​        the Load-Balancer is using only one interface and this interface is on the same L2 network with all the servers.</p>
<p>​        The traffic that the client initializes will get to the Load-Balancer that has the virtual load-balanced IP. The load-sharing algorithm will pick a physical server to which the Load-Balancer will forward the traffic with destination IP NATed to the physical IP of the server and forward it out the same interface towards the physical server.BUT the Load-balancer also needs to do source IP nat so that the server reply will go back from the server to the Load-Balancer and not directly back to the Client, who is not expecting a reply directly from physical server IP. From the physical servers perspective, all the traffic is coming from Load-Balancer</p>
<p><img src="/2017/03/07/Openstack负载均衡LoadBalancerv2/2.jpg" alt=""></p>
<p><strong>Direct Server Response (or sometimes called Direct Server Return)</strong></p>
<p>​        As we hopefully all know, switches learn about MAC addresses as they see frames coming on ports with source MACs. Also imagine that we have a router that has to know the MAC address of the Load-Balanced IP on the last L3 hop. With the picture below, you can already spot the “trick” this scenario tries to present here once you notice the disabled ARP on physical servers</p>
<p><img src="/2017/03/07/Openstack负载均衡LoadBalancerv2/3.jpg" alt=""></p>
<p>​          In this scenario, Load-balancer only sees the incoming part of client-server traffic and all the returning traffic from physical servers is coming directly back to the client IP. The biggest advantages of this solution is that there is no NAT and the Load-Balancer throughput is only used in one way, so less performance impact for the Load-Balancer system. Disabling ARP on a physical server is not a difficult task.</p>
<p>​          Disadvantages however are that you have to manually configure the Load-Balancer with all the server MAC addresses and might be more difficult to troubleshoot with only one way traffic seen by the Load-Balancer on the whole L2 segment.</p>
<h3 id="LoadBalancerv2初体验？"><a href="#LoadBalancerv2初体验？" class="headerlink" title="LoadBalancerv2初体验？"></a>LoadBalancerv2初体验？</h3><p><strong>1.部署</strong></p>
<p>我们假设LoadBalancerv2服务在网络节点启动，以yum源的方式安装。源码是：</p>
<p><a href="https://github.com/openstack/neutron-lbaas/tree/stable/mitaka" target="_blank" rel="external">https://github.com/openstack/neutron-lbaas/tree/stable/mitaka</a></p>
<p>在控制节点(neutron-server)操作如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">yum install openstack-neutron-lbaas</div><div class="line"></div><div class="line">cd /etc/neutron/</div><div class="line"></div><div class="line">#1.3编辑neutron.conf文件</div><div class="line"></div><div class="line">service_plugins =router, neutron_lbaas.services.loadbalancer.plugin.LoadBalancerPluginv2</div><div class="line"></div><div class="line">#1.4 编辑lbaas_agent.ini 文件</div><div class="line"></div><div class="line">[DEFAULT]</div><div class="line"></div><div class="line">interface_driver =neutron.agent.linux.interface.OVSInterfaceDriver</div><div class="line"></div><div class="line">ovs_use_veth = True</div><div class="line"></div><div class="line">device_driver = neutron_lbaas.drivers.haproxy.namespace_driver.HaproxyNSDriver</div><div class="line"></div><div class="line">[haproxy]</div><div class="line"></div><div class="line">user_group =haproxy</div><div class="line"></div><div class="line">#1.5 编辑neutron_lbaas.conf文件</div><div class="line"></div><div class="line">service_provider =LOADBALANCERV2:Haproxy:neutron_lbaas.drivers.haproxy.plugin_driver.HaproxyOnHostPluginDriver:default</div><div class="line"></div><div class="line">#然后执行</div><div class="line"></div><div class="line">neutron-db-manage --subproject neutron-lbaas upgrade head</div><div class="line"></div><div class="line">systemctl restart neutron-server</div></pre></td></tr></table></figure>
<p>在网络节点操作如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">yum install haproxy</div><div class="line"></div><div class="line">yum install openstack-neutron-lbaas</div><div class="line"></div><div class="line">cd /etc/neutron/</div><div class="line"></div><div class="line">#1.4 编辑neutron.conf文件</div><div class="line"></div><div class="line">service_plugins =router, neutron_lbaas.services.loadbalancer.plugin.LoadBalancerPluginv2</div><div class="line"></div><div class="line">#1.5 编辑lbaas_agent.ini 文件</div><div class="line"></div><div class="line">[DEFAULT]</div><div class="line"></div><div class="line">interface_driver =neutron.agent.linux.interface.OVSInterfaceDriver</div><div class="line"></div><div class="line">ovs_use_veth = True</div><div class="line"></div><div class="line">device_driver = neutron_lbaas.drivers.haproxy.namespace_driver.HaproxyNSDriver</div><div class="line"></div><div class="line">[haproxy]</div><div class="line"></div><div class="line">user_group =haproxy</div><div class="line"></div><div class="line">#1.6 编辑neutron_lbaas.conf文件</div><div class="line"></div><div class="line">service_provider =LOADBALANCERV2:Haproxy:neutron_lbaas.drivers.haproxy.plugin_driver.HaproxyOnHostPluginDriver:default</div><div class="line"></div><div class="line">#1.7启动服务</div><div class="line"></div><div class="line">systemctl start neutron-lbaasv2-agent.service</div></pre></td></tr></table></figure>
<p>另外可以安装前端界面</p>
<p>1.8安装neutron-lbaas-dashboard<br>这个是在openstack_dashboard安装的节点，一般是controller节点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">git clone https://git.openstack.org/openstack/neutron-lbaas-dashboard</div><div class="line"></div><div class="line">cd neutron-lbaas-dashboard</div><div class="line"></div><div class="line">python setup.py install</div><div class="line"></div><div class="line">cp neutron_lbaas_dashboard/enabled/1480project_loadbalancersv2_panel.py /usr/share/openstack-dashboard/openstack_dashboard/local/enabled/</div><div class="line"></div><div class="line">systemctl restart httpd.service memcached.service</div></pre></td></tr></table></figure>
<p><img src="/2017/03/07/Openstack负载均衡LoadBalancerv2/3.png" alt=""></p>
<p><strong>2.创建负载均衡</strong></p>
<p><img src="/2017/03/07/Openstack负载均衡LoadBalancerv2/4.png" alt=""></p>
<p>Load balancer<br>The load balancer occupies a neutron network port and has an IP address assigned from a subnet.<br>Listener<br>Load balancers can listen for requests on multiple ports. Each one of those ports is specified by a listener.<br>Pool<br>A pool holds a list of members that serve content through the load balancer.<br>Member<br>Members are servers that serve traffic behind a load balancer. Each member is specified by the IP address and port that it uses to serve traffic.<br>Health monitor<br>Members may go offline from time to time and health monitors divert traffic away from members that are not responding properly. Health monitors are associated with pools.<br>由于lbaas dashboard有些问题，所以在后台用命令行创建， dashboard可显示，但不能任何操作</p>
<p><img src="/2017/03/07/Openstack负载均衡LoadBalancerv2/5.png" alt=""></p>
<p>[root@controller ~]# source admin-openrc.sh </p>
<p>[root@controller ~]# neutron subnet-list</p>
<p><img src="/2017/03/07/Openstack负载均衡LoadBalancerv2/6.png" alt=""></p>
<p>创建loadbalancer<br>[root@controller ~]# neutron lbaas-loadbalancer-create –name lb1 96f0db98-45fb-48ef-afae-808425fbb2bc<br>添加lbaas-listener<br>[root@controller ~]# neutron lbaas-listener-create –loadbalancer lb1 –protocol HTTP –protocol-port 80 –name listener1<br>创建pool<br>[root@controller ~]# neutron lbaas-pool-create –lb-algorithm ROUND_ROBIN –listener listener1 –protocol HTTP –name pool1<br>添加member<br>[root@controller ~]# neutron lbaas-member-create –subnet 96f0db98-45fb-48ef-afae-808425fbb2bc –address 172.16.1.4 –protocol-port 80 pool1<br>[root@controller ~]# neutron lbaas-member-create –subnet 96f0db98-45fb-48ef-afae-808425fbb2bc –address 172.16.1.5 –protocol-port 80 pool1<br>[root@controller ~]# neutron lbaas-member-create –subnet 96f0db98-45fb-48ef-afae-808425fbb2bc –address 172.16.1.6 –protocol-port 80 pool1<br>添加监控<br>[root@controller ~]# neutron lbaas-healthmonitor-create –delay 3 –type HTTP –max-retries 3 –timeout 3 –pool pool1</p>
<p>[root@controller ~]# neutron lbaas-loadbalancer-show lb1</p>
<p><img src="/2017/03/07/Openstack负载均衡LoadBalancerv2/7.png" alt=""></p>
<p><img src="/2017/03/07/Openstack负载均衡LoadBalancerv2/8.png" alt=""></p>
<p>3.简单验证：</p>
<p>我们对member成员进行模拟http服务，即172.16.1.4,172.16.1.5,172.16.1.6分别运行</p>
<p><img src="/2017/03/07/Openstack负载均衡LoadBalancerv2/9.png" alt=""></p>
<p>172.16.1.4<br>while true; do echo -e ‘HTTP/1.0 200 OK\r\nContent-Length: 8\r\n\r\nserver1’ | sudo nc -l -p 80 ; done<br>172.16.1.5<br>while true; do echo -e ‘HTTP/1.0 200 OK\r\nContent-Length: 8\r\n\r\nserver2’ | sudo nc -l -p 80 ; done<br>172.16.1.6<br>while true; do echo -e ‘HTTP/1.0 200 OK\r\nContent-Length: 8\r\n\r\nserver3’ | sudo nc -l -p 80 ; done</p>
<p>然后创建一个客户端访问负载均衡的vip 172.16.1.9 ,多次执行,如下图<br>wget -O - http:// 172.16.1.9 （第一次）<br>wget -O - http:// 172.16.1.9  （第二次）<br>wget -O - http:// 172.16.1.9  （第三次）<br>wget -O - http:// 172.16.1.9（第四次）</p>
<p><img src="/2017/03/07/Openstack负载均衡LoadBalancerv2/10.png" alt=""></p>
<p>我们发现第一次是server1响应</p>
<p><img src="/2017/03/07/Openstack负载均衡LoadBalancerv2/4.jpg" alt=""></p>
<p>第二次是server2响应</p>
<p><img src="/2017/03/07/Openstack负载均衡LoadBalancerv2/5.jpg" alt=""></p>
<p>第三次是server3响应</p>
<p><img src="/2017/03/07/Openstack负载均衡LoadBalancerv2/6.jpg" alt=""></p>
<p>第四次是server1响应</p>
<p><img src="/2017/03/07/Openstack负载均衡LoadBalancerv2/7.jpg" alt=""></p>
<h3 id="参考："><a href="#参考：" class="headerlink" title="参考："></a>参考：</h3><p><a href="http://networkgeekstuff.com/networking/basic-load-balancer-scenarios-explained/" target="_blank" rel="external">http://networkgeekstuff.com/networking/basic-load-balancer-scenarios-explained/</a></p>
<p><a href="https://docs.openstack.org/mitaka/networking-guide/config-lbaas.html" target="_blank" rel="external">https://docs.openstack.org/mitaka/networking-guide/config-lbaas.html</a></p>
<p><a href="http://www.cnblogs.com/sammyliu/p/4656176.html" target="_blank" rel="external">http://www.cnblogs.com/sammyliu/p/4656176.html</a></p>
<p><a href="http://blog.csdn.net/u013628152/article/details/51318414" target="_blank" rel="external">http://blog.csdn.net/u013628152/article/details/51318414</a></p>

      
    </div>

    <div>
      
        
<div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/uploads/1.jpg" alt="Luckylau wechat" style="width: 200px; max-width: 100%;"/>
    <div>如果对您有价值,看官可以打赏的！</div>
</div>


      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/neutron/" rel="tag"># neutron</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/03/06/Python-yield-使用浅析/" rel="next" title="Python yield 使用浅析">
                <i class="fa fa-chevron-left"></i> Python yield 使用浅析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/03/08/IO的同步与异步，阻塞与非阻塞/" rel="prev" title="IO的同步与异步，阻塞与非阻塞">
                IO的同步与异步，阻塞与非阻塞 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <div class="ds-share flat" data-thread-key="2017/03/07/Openstack负载均衡LoadBalancerv2/"
     data-title="Openstack 负载均衡 LoadBalancerv2"
     data-content=""
     data-url="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/">
  <div class="ds-share-inline">
    <ul  class="ds-share-icons-16">

      <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
      <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
      <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
      <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
      <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>

    </ul>
    <div class="ds-share-icons-more">
    </div>
  </div>
</div>
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2017/03/07/Openstack负载均衡LoadBalancerv2/"
           data-title="Openstack 负载均衡 LoadBalancerv2" data-url="https://luckylau.github.io/2017/03/07/Openstack负载均衡LoadBalancerv2/">
      </div>
	  <!-- 多说公共JS代码 start (一个网页只需插入一次) -->
    <script type="text/javascript">
var duoshuoQuery = {short_name:"luckylau"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/logo.jpg"
               alt="Luckylau" />
          <p class="site-author-name" itemprop="name">Luckylau</p>
          <p class="site-description motion-element" itemprop="description">人生识字忧患始</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">33</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Luckylau" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://weibo.com/2606534415/profile?topnav=1&wvr=6&is_all=1" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#负载均衡的概念和分类？"><span class="nav-number">1.</span> <span class="nav-text">负载均衡的概念和分类？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#负载均衡的实现方式？"><span class="nav-number">2.</span> <span class="nav-text">负载均衡的实现方式？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常见的开源软件负载均衡器？"><span class="nav-number">3.</span> <span class="nav-text">常见的开源软件负载均衡器？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#负载均衡部署模式？"><span class="nav-number">4.</span> <span class="nav-text">负载均衡部署模式？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LoadBalancerv2初体验？"><span class="nav-number">5.</span> <span class="nav-text">LoadBalancerv2初体验？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考："><span class="nav-number">6.</span> <span class="nav-text">参考：</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Luckylau</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"luckylau"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  












  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  


</body>
</html>
