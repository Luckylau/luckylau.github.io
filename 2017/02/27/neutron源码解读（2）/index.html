<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="neutron源码," />








  <link rel="shortcut icon" type="image/x-icon" href="/logo.jpg?v=5.1.0" />






<meta name="description" content="本文是基于Mitaka版本（20170227最新的代码）学习。
首先从控制节点入手，neutron-server包括
neutron-server：neutron\cmd\eventlet\server:main
neutron-rpc-server：neutron\cmd\eventlet\server:main_rpc_eventlet两部分">
<meta property="og:type" content="article">
<meta property="og:title" content="neutron源码解读（2）">
<meta property="og:url" content="https://luckylau.github.io/2017/02/27/neutron源码解读（2）/index.html">
<meta property="og:site_name" content="Luckylau's Blog">
<meta property="og:description" content="本文是基于Mitaka版本（20170227最新的代码）学习。
首先从控制节点入手，neutron-server包括
neutron-server：neutron\cmd\eventlet\server:main
neutron-rpc-server：neutron\cmd\eventlet\server:main_rpc_eventlet两部分">
<meta property="og:updated_time" content="2017-03-27T07:24:46.694Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="neutron源码解读（2）">
<meta name="twitter:description" content="本文是基于Mitaka版本（20170227最新的代码）学习。
首先从控制节点入手，neutron-server包括
neutron-server：neutron\cmd\eventlet\server:main
neutron-rpc-server：neutron\cmd\eventlet\server:main_rpc_eventlet两部分">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://luckylau.github.io/2017/02/27/neutron源码解读（2）/"/>





  <title> neutron源码解读（2） | Luckylau's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Luckylau's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
    
      <p class="site-subtitle">Keep Moving, Keep Learning</p>
    
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup">
 <span class="search-icon fa fa-search"></span>
 <input type="text" id="local-search-input">
 <div id="local-search-result"></div>
 <span class="popup-btn-close">close</span>
</div>


    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="https://luckylau.github.io/2017/02/27/neutron源码解读（2）/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Luckylau">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/logo.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Luckylau's Blog">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Luckylau's Blog" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                neutron源码解读（2）
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-02-27T20:04:26+08:00">
                2017-02-27
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/neutron/" itemprop="url" rel="index">
                    <span itemprop="name">neutron</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本文是基于Mitaka版本（20170227最新的代码）学习。</p>
<p>首先从控制节点入手，neutron-server包括</p>
<p>neutron-server：neutron\cmd\eventlet\server:main</p>
<p>neutron-rpc-server：neutron\cmd\eventlet\server:main_rpc_eventlet两部分</p>
<a id="more"></a>
<p><strong>本文主要描述Paste + PasteDeploy + Routes + WebOb实现neutron-server的api服务过程。</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#/neutron/cmd/eventlet/server/__init__.py</span></div><div class="line"><span class="keyword">from</span> oslo_config <span class="keyword">import</span> cfg</div><div class="line"><span class="keyword">from</span> neutron <span class="keyword">import</span> server</div><div class="line"><span class="keyword">from</span> neutron.server <span class="keyword">import</span> rpc_eventlet</div><div class="line"><span class="keyword">from</span> neutron.server <span class="keyword">import</span> wsgi_eventlet</div><div class="line"><span class="keyword">from</span> neutron.server <span class="keyword">import</span> wsgi_pecan</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    server.boot_server(_main_neutron_server)</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_main_neutron_server</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">if</span> cfg.CONF.web_framework == <span class="string">'legacy'</span>:</div><div class="line">        wsgi_eventlet.eventlet_wsgi_server()<span class="comment"># 使用原先实现 eventlet_wsgi_server 启动服务</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        wsgi_pecan.pecan_wsgi_server()<span class="comment">#使用新实现 Pecan WSGI server启动服务</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main_rpc_eventlet</span><span class="params">()</span>:</span></div><div class="line">    server.boot_server(rpc_eventlet.eventlet_rpc_server)</div></pre></td></tr></table></figure>
<p>这段代码是控制节点的核心，包含了neutron-server和neutron-rpc-server，其任务也即：api服务和rpc服务，包括RPC-server的创建，RPC-client的创建，WSGI server的创建。</p>
<p>server.boot_server()代码如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#/neutron/server/__init__.py</span></div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">from</span> oslo_config <span class="keyword">import</span> cfg</div><div class="line"><span class="keyword">from</span> neutron._i18n <span class="keyword">import</span> _</div><div class="line"><span class="keyword">from</span> neutron.common <span class="keyword">import</span> config</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">boot_server</span><span class="params">(server_func)</span>:</span></div><div class="line">    <span class="comment"># the configuration will be read into the cfg.CONF global data structure</span></div><div class="line">    config.init(sys.argv[<span class="number">1</span>:])</div><div class="line">    config.setup_logging()</div><div class="line">    config.set_config_defaults()</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cfg.CONF.config_file:</div><div class="line">        sys.exit(_(<span class="string">"ERROR: Unable to find configuration file via the default"</span></div><div class="line">                   <span class="string">" search paths (~/.neutron/, ~/, /etc/neutron/, /etc/) and"</span></div><div class="line">                   <span class="string">" the '--config-file' option!"</span>))</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        server_func()</div><div class="line">    <span class="keyword">except</span> KeyboardInterrupt:</div><div class="line">        <span class="keyword">pass</span></div><div class="line">    <span class="keyword">except</span> RuntimeError <span class="keyword">as</span> e:</div><div class="line">        sys.exit(_(<span class="string">"ERROR: %s"</span>) % e)</div></pre></td></tr></table></figure>
<p>​    boot_server做的事情就是读取neutron\common\config配置文件，做初始化，包括日志，配置等，然后 server_func()，也即_main_neutron_server()启动。因为在api服务实现上目前有两种方式，”legacy”和”pecan”,根据读取的neutron\common\config中的配置来启动api服务。我们看”legacy”模式，也即</p>
<p>Paste + PasteDeploy + Routes + WebOb，这几个不同的模块分别负责应用的WSGI化、URL路由和请求处理等功能。</p>
<p>wsgi_eventlet.eventlet_wsgi_server()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#/neutron/server/wsgi_eventlet.py</span></div><div class="line"><span class="keyword">import</span> eventlet</div><div class="line"><span class="keyword">from</span> oslo_log <span class="keyword">import</span> log</div><div class="line"><span class="keyword">from</span> neutron._i18n <span class="keyword">import</span> _LI</div><div class="line"><span class="keyword">from</span> neutron <span class="keyword">import</span> service</div><div class="line">LOG = log.getLogger(__name__)</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">eventlet_wsgi_server</span><span class="params">()</span>:</span></div><div class="line">    neutron_api = service.serve_wsgi(service.NeutronApiService)</div><div class="line">    start_api_and_rpc_workers(neutron_api)</div></pre></td></tr></table></figure>
<p>neutron_api = service.serve_wsgi(service.NeutronApiService)，主要是创建服务，并启动。关键在于NeutronApiService，NeutronApiService继承了WsgiService类，调用了它的start方法，即_run_wsgi(app_name)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#/neutron/service.py</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">serve_wsgi</span><span class="params">(cls)</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        service = cls.create() <span class="comment"># create(cls, app_name='neutron')</span></div><div class="line">        service.start() <span class="comment"># _run_wsgi(self.app_name)</span></div><div class="line">    <span class="keyword">except</span> Exception:</div><div class="line">        <span class="keyword">with</span> excutils.save_and_reraise_exception():</div><div class="line">            LOG.exception(_LE(<span class="string">'Unrecoverable error: please check log '</span></div><div class="line">                              <span class="string">'for details.'</span>))</div><div class="line">    <span class="keyword">return</span> service</div><div class="line"><span class="comment">#/neutron/service.py：NeutronApiService</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">NeutronApiService</span><span class="params">(WsgiService)</span>:</span></div><div class="line">    <span class="string">"""Class for neutron-api service."""</span></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(cls, app_name=<span class="string">'neutron'</span>)</span>:</span></div><div class="line">        <span class="comment"># Setup logging early, supplying both the CLI options and the</span></div><div class="line">        <span class="comment"># configuration mapping from the config file</span></div><div class="line">        <span class="comment"># We only update the conf dict for the verbose and debug</span></div><div class="line">        <span class="comment"># flags. Everything else must be set up in the conf file...</span></div><div class="line">        <span class="comment"># Log the options used when starting if we're in debug mode...</span></div><div class="line">        config.setup_logging()</div><div class="line">        service = cls(app_name)</div><div class="line">        <span class="keyword">return</span> service</div><div class="line"> <span class="comment">#/neutron/service.py：WsgiService</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WsgiService</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""Base class for WSGI based services.</span></div><div class="line">    For each api you define, you must also define these flags:</div><div class="line">    :&lt;api&gt;_listen: The address on which to listen</div><div class="line">    :&lt;api&gt;_listen_port: The port on which to listen</div><div class="line">    """</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, app_name)</span>:</span></div><div class="line">        self.app_name = app_name</div><div class="line">        self.wsgi_app = <span class="keyword">None</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></div><div class="line">        self.wsgi_app = _run_wsgi(self.app_name)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span><span class="params">(self)</span>:</span></div><div class="line">        self.wsgi_app.wait()</div><div class="line"> <span class="comment">#/neutron/service.py   </span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">_run_wsgi</span><span class="params">(app_name)</span>:</span></div><div class="line">    app = config.load_paste_app(app_name)</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> app:</div><div class="line">        LOG.error(_LE(<span class="string">'No known API applications configured.'</span>))</div><div class="line">        <span class="keyword">return</span></div><div class="line">    <span class="keyword">return</span> run_wsgi_app(app)</div></pre></td></tr></table></figure>
<p>_run_wsgi(app_name)包括load_paste_app()和run_wsgi_app()。load_paste_app()从api-paste.ini文件加载composite为neutron的相关信息，生成一个应用。这个很关键，我们看看api-paste.ini文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">[composite:neutron]</div><div class="line">use = egg:Paste#urlmap</div><div class="line">/: neutronversions</div><div class="line">/v2.0: neutronapi_v2_0</div><div class="line"></div><div class="line">[composite:neutronapi_v2_0]</div><div class="line">use = call:neutron.auth:pipeline_factory</div><div class="line">noauth = cors request_id catch_errors extensions neutronapiapp_v2_0</div><div class="line">keystone = cors request_id catch_errors authtoken keystonecontext extensions neutronapiapp_v2_0</div><div class="line"></div><div class="line">[filter:request_id]</div><div class="line">paste.filter_factory = oslo_middleware:RequestId.factory</div><div class="line"></div><div class="line">[filter:catch_errors]</div><div class="line">paste.filter_factory = oslo_middleware:CatchErrors.factory</div><div class="line"></div><div class="line">[filter:cors]</div><div class="line">paste.filter_factory = oslo_middleware.cors:filter_factory</div><div class="line">oslo_config_project = neutron</div><div class="line"></div><div class="line">[filter:keystonecontext]</div><div class="line">paste.filter_factory = neutron.auth:NeutronKeystoneContext.factory</div><div class="line"></div><div class="line">[filter:authtoken]</div><div class="line">paste.filter_factory = keystonemiddleware.auth_token:filter_factory</div><div class="line"></div><div class="line">[filter:extensions]</div><div class="line">paste.filter_factory = neutron.api.extensions:plugin_aware_extension_middleware_factory</div><div class="line"></div><div class="line">[app:neutronversions]</div><div class="line">paste.app_factory = neutron.api.versions:Versions.factory</div><div class="line"></div><div class="line">[app:neutronapiapp_v2_0]</div><div class="line">paste.app_factory = neutron.api.v2.router:APIRouter.factory</div></pre></td></tr></table></figure>
<p>最终调用了/v2.0: neutronapi_v2_0，具体是neutron.api.v2.router:APIRouter.factory，v2版api的实现是在neutron.api.v2.router:APIRouter，位于neutron\neutron\api\v2\router.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">APIRouter</span><span class="params">(base_wsgi.Router)</span>:</span></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">factory</span><span class="params">(cls, global_config, **local_config)</span>:</span></div><div class="line">        <span class="keyword">return</span> cls(**local_config)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, **local_config)</span>:</span></div><div class="line">        mapper = routes_mapper.Mapper()</div><div class="line">        <span class="comment">#获取NeutornManage的core_plugin，这个定义在/etc/neutron/neutron.conf,</span></div><div class="line">        <span class="comment">#比如我的是core_plugin = ml2,service_plugins = router</span></div><div class="line">        plugin = manager.NeutronManager.get_plugin()</div><div class="line">        <span class="comment">#扫描特定路径下的extensions</span></div><div class="line">        ext_mgr = extensions.PluginAwareExtensionManager.get_instance()</div><div class="line">        <span class="comment">#扩展资源，包括networks，subnets,ports,subnetpools</span></div><div class="line">        ext_mgr.extend_resources(<span class="string">"2.0"</span>, attributes.RESOURCE_ATTRIBUTE_MAP)</div><div class="line">        col_kwargs = dict(collection_actions=COLLECTION_ACTIONS,</div><div class="line">                          member_actions=MEMBER_ACTIONS)</div><div class="line">        <span class="comment">#定义的局部方法</span></div><div class="line">   	    <span class="function"><span class="keyword">def</span> <span class="title">_map_resource</span><span class="params">(collection, resource, params, parent=None)</span>:</span></div><div class="line">        	allow_bulk = cfg.CONF.allow_bulk</div><div class="line">          	allow_pagination = cfg.CONF.allow_pagination</div><div class="line">        	allow_sorting = cfg.CONF.allow_sorting</div><div class="line">        	controller = base.create_resource(</div><div class="line">                collection, resource, plugin, params, allow_bulk=allow_bulk,</div><div class="line">                parent=parent, allow_pagination=allow_pagination,</div><div class="line">                allow_sorting=allow_sorting)</div><div class="line">         	path_prefix = <span class="keyword">None</span></div><div class="line">            <span class="keyword">if</span> parent:</div><div class="line">                path_prefix = <span class="string">"/%s/&#123;%s_id&#125;/%s"</span> % (parent[<span class="string">'collection_name'</span>],</div><div class="line">                                                  parent[<span class="string">'member_name'</span>],</div><div class="line">                                                  collection)</div><div class="line">            mapper_kwargs = dict(controller=controller,</div><div class="line">                                 requirements=REQUIREMENTS,</div><div class="line">                                 path_prefix=path_prefix,</div><div class="line">                                 **col_kwargs)</div><div class="line">            <span class="keyword">return</span> mapper.collection(collection, resource,</div><div class="line">                                     **mapper_kwargs)</div><div class="line"></div><div class="line">        mapper.connect(<span class="string">'index'</span>, <span class="string">'/'</span>, controller=Index(RESOURCES))</div><div class="line">        <span class="keyword">for</span> resource <span class="keyword">in</span> RESOURCES:</div><div class="line">            _map_resource(RESOURCES[resource], resource,</div><div class="line">                          attributes.RESOURCE_ATTRIBUTE_MAP.get(</div><div class="line">                              RESOURCES[resource], dict()))</div><div class="line">            resource_registry.register_resource_by_name(resource)</div><div class="line"></div><div class="line">        <span class="keyword">for</span> resource <span class="keyword">in</span> SUB_RESOURCES:</div><div class="line">            _map_resource(SUB_RESOURCES[resource][<span class="string">'collection_name'</span>], resource,</div><div class="line">                          attributes.RESOURCE_ATTRIBUTE_MAP.get(</div><div class="line">                              SUB_RESOURCES[resource][<span class="string">'collection_name'</span>],</div><div class="line">                              dict()),</div><div class="line">                          SUB_RESOURCES[resource][<span class="string">'parent'</span>])</div><div class="line"></div><div class="line">        <span class="comment"># Certain policy checks require that the extensions are loaded</span></div><div class="line">        <span class="comment"># and the RESOURCE_ATTRIBUTE_MAP populated before they can be</span></div><div class="line">        <span class="comment"># properly initialized. This can only be claimed with certainty</span></div><div class="line">        <span class="comment"># once this point in the code has been reached. In the event</span></div><div class="line">        <span class="comment"># that the policies have been initialized before this point,</span></div><div class="line">        <span class="comment"># calling reset will cause the next policy check to</span></div><div class="line">        <span class="comment"># re-initialize with all of the required data in place.</span></div><div class="line">        policy.reset()</div><div class="line">        super(APIRouter, self).__init__(mapper)</div></pre></td></tr></table></figure>
<p>我们好好分析上述代码做了什么，这是很关键的部分。</p>
<p>创建plugin(包括core plugin和service plugin)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#/neutron/api/v2/router.py:APIRouter  </span></div><div class="line">plugin = manager.NeutronManager.get_plugin()</div><div class="line"><span class="comment">#/neutron/manager.py:NeutronManager</span></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_plugin</span><span class="params">(cls)</span>:</span></div><div class="line">        <span class="comment"># Return a weakref to minimize gc-preventing references.</span></div><div class="line">        <span class="keyword">return</span> weakref.proxy(cls.get_instance().plugin)</div><div class="line"><span class="comment">#/neutron/manager.py:NeutronManager </span></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_instance</span><span class="params">(cls)</span>:</span></div><div class="line">        <span class="comment"># double checked locking</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> cls.has_instance():</div><div class="line">            cls._create_instance()</div><div class="line">        <span class="keyword">return</span> cls._instance</div><div class="line"><span class="comment">#/neutron/manager.py:NeutronManager     </span></div><div class="line"><span class="meta">    @classmethod</span></div><div class="line"><span class="meta">    @utils.synchronized("manager")</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_create_instance</span><span class="params">(cls)</span>:</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> cls.has_instance():</div><div class="line">            cls._instance = cls()</div><div class="line"><span class="comment">#/neutron/manager.py:NeutronManager</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">NeutronManager</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""Neutron's Manager class.</span></div><div class="line">    Neutron's Manager class is responsible for parsing a config file and</div><div class="line">    instantiating the correct plugin that concretely implements</div><div class="line">    neutron_plugin_base class.</div><div class="line">    The caller should make sure that NeutronManager is a singleton.</div><div class="line">    """</div><div class="line">    _instance = <span class="keyword">None</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, options=None, config_file=None)</span>:</span></div><div class="line">        <span class="comment"># If no options have been provided, create an empty dict</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> options:</div><div class="line">            options = &#123;&#125;</div><div class="line"></div><div class="line">        msg = validate_pre_plugin_load()</div><div class="line">        <span class="keyword">if</span> msg:</div><div class="line">            LOG.critical(msg)</div><div class="line">            <span class="keyword">raise</span> Exception(msg)</div><div class="line"></div><div class="line">        <span class="comment"># NOTE(jkoelker) Testing for the subclass with the __subclasshook__</span></div><div class="line">        <span class="comment">#                breaks tach monitoring. It has been removed</span></div><div class="line">        <span class="comment">#                intentionally to allow v2 plugins to be monitored</span></div><div class="line">        <span class="comment">#                for performance metrics.</span></div><div class="line">        plugin_provider = cfg.CONF.core_plugin</div><div class="line">        LOG.info(_LI(<span class="string">"Loading core plugin: %s"</span>), plugin_provider)</div><div class="line">        self.plugin = self._get_plugin_instance(CORE_PLUGINS_NAMESPACE,</div><div class="line">                                                plugin_provider)</div><div class="line">        msg = validate_post_plugin_load()</div><div class="line">        <span class="keyword">if</span> msg:</div><div class="line">            LOG.critical(msg)</div><div class="line">            <span class="keyword">raise</span> Exception(msg)</div><div class="line"></div><div class="line">        <span class="comment"># core plugin as a part of plugin collection simplifies</span></div><div class="line">        <span class="comment"># checking extensions</span></div><div class="line">        <span class="comment"># TODO(enikanorov): make core plugin the same as</span></div><div class="line">        <span class="comment"># the rest of service plugins</span></div><div class="line">        self.service_plugins = &#123;constants.CORE: self.plugin&#125;</div><div class="line">        self._load_service_plugins()</div><div class="line">        <span class="comment"># Used by pecan WSGI</span></div><div class="line">        self.resource_plugin_mappings = &#123;&#125;</div><div class="line">        self.resource_controller_mappings = &#123;&#125;</div></pre></td></tr></table></figure>
<p>​    get_plugin函数返回NeutronManager的plugin(core plugin)的弱引用，那么core plugin是什么对象呢?core plugin和service plugin在NeutronManager的<code>__init__</code>函数创建的。其中core plugin和service plugin分别根据neutron.conf配置文件中的core_plugin参数和service_plugins参数进行创建。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#/neutron/manager.py:NeutronManager </span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_plugin_instance</span><span class="params">(self, namespace, plugin_provider)</span>:</span></div><div class="line">    plugin_class = self.load_class_for_provider(namespace, plugin_provider)</div><div class="line">    <span class="keyword">return</span> plugin_class()</div><div class="line"><span class="meta">    @staticmethod</span></div><div class="line"><span class="comment">#/neutron/manager.py:NeutronManager   </span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">load_class_for_provider</span><span class="params">(namespace, plugin_provider)</span>:</span></div><div class="line">    <span class="string">"""Loads plugin using alias or class name</span></div><div class="line">    :param namespace: namespace where alias is defined</div><div class="line">    :param plugin_provider: plugin alias or class name</div><div class="line">    :returns plugin that is loaded</div><div class="line">    :raises ImportError if fails to load plugin</div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        <span class="keyword">return</span> utils.load_class_by_alias_or_classname(namespace,</div><div class="line">                plugin_provider)</div><div class="line">    <span class="keyword">except</span> ImportError:</div><div class="line">        <span class="keyword">raise</span> ImportError(_(<span class="string">"Plugin '%s' not found."</span>) % plugin_provider)</div><div class="line"><span class="comment">#/neutron/common/utils.py</span></div><div class="line"> <span class="function"><span class="keyword">def</span> <span class="title">load_class_by_alias_or_classname</span><span class="params">(namespace, name)</span>:</span></div><div class="line"><span class="string">"""Load class using stevedore alias or the class name</span></div><div class="line">:param namespace: namespace where the alias is defined</div><div class="line">:param name: alias or class name of the class to be loaded</div><div class="line">:returns class if calls can be loaded</div><div class="line">:raises ImportError if class cannot be loaded</div><div class="line">"""</div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="keyword">not</span> name:</div><div class="line">    LOG.error(_LE(<span class="string">"Alias or class name is not set"</span>))</div><div class="line">    <span class="keyword">raise</span> ImportError(_(<span class="string">"Class not found."</span>))</div><div class="line"><span class="keyword">try</span>:</div><div class="line">    <span class="comment"># Try to resolve class by alias</span></div><div class="line">    mgr = driver.DriverManager(namespace, name) <span class="comment"># 利用stevedore模块创建core_plugin</span></div><div class="line">    class_to_load = mgr.driver</div><div class="line"><span class="keyword">except</span> RuntimeError:</div><div class="line">    e1_info = sys.exc_info()</div><div class="line">    <span class="comment"># Fallback to class name</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        class_to_load = importutils.import_class(name)</div><div class="line">    <span class="keyword">except</span> (ImportError, ValueError):</div><div class="line">        LOG.error(_LE(<span class="string">"Error loading class by alias"</span>),</div><div class="line">                  exc_info=e1_info)</div><div class="line">        LOG.error(_LE(<span class="string">"Error loading class by class name"</span>),</div><div class="line">                  exc_info=<span class="keyword">True</span>)</div><div class="line">        <span class="keyword">raise</span> ImportError(_(<span class="string">"Class not found."</span>))</div><div class="line"><span class="keyword">return</span> class_to_load</div></pre></td></tr></table></figure>
<p>在def load_class_by_alias_or_classname(namespace, name)中我们调用mgr = driver.DriverManager(namespace, name)加载core_plugin，即ml2。</p>
<p>在配置文件setup.cfg中ml2 = neutron.plugins.ml2.plugin:Ml2Plugin，我们查看它的源码，如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#/neutron/plugins/ml2/plugin.py:Ml2Plugin</span></div><div class="line"> <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment"># First load drivers, then initialize DB, then initialize drivers</span></div><div class="line">        self.type_manager = managers.TypeManager()           <span class="comment">#</span></div><div class="line">        self.extension_manager = managers.ExtensionManager() <span class="comment">#</span></div><div class="line">        self.mechanism_manager = managers.MechanismManager() <span class="comment">#</span></div><div class="line">        super(Ml2Plugin, self).__init__()</div><div class="line">        self.type_manager.initialize()                       <span class="comment"># 初始化</span></div><div class="line">        self.extension_manager.initialize()                  <span class="comment"># 初始化</span></div><div class="line">        self.mechanism_manager.initialize()                  <span class="comment"># 初始化</span></div><div class="line">        self._setup_dhcp()</div><div class="line">        self._start_rpc_notifiers()</div><div class="line">        self.add_agent_status_check(self.agent_health_check)</div><div class="line">        self._verify_service_plugins_requirements()</div><div class="line">        LOG.info(_LI(<span class="string">"Modular L2 Plugin initialization complete"</span>))</div></pre></td></tr></table></figure>
<p>由于type_manager，extension_manager和mechanism_manager的创建都类似，所以这里我们主要分析type_manager代码流程，其余的简要说明。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TypeManager</span><span class="params">(stevedore.named.NamedExtensionManager)</span>:</span></div><div class="line">    <span class="string">"""Manage network segment types using drivers."""</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment"># Mapping from type name to DriverManager</span></div><div class="line">        self.drivers = &#123;&#125;</div><div class="line"></div><div class="line">        LOG.info(_LI(<span class="string">"Configured type driver names: %s"</span>),</div><div class="line">                 cfg.CONF.ml2.type_drivers)</div><div class="line">        super(TypeManager, self).__init__(<span class="string">'neutron.ml2.type_drivers'</span>,</div><div class="line">                                          cfg.CONF.ml2.type_drivers,</div><div class="line">                                          invoke_on_load=<span class="keyword">True</span>)</div><div class="line">        LOG.info(_LI(<span class="string">"Loaded type driver names: %s"</span>), self.names())</div><div class="line">        self._register_types()</div><div class="line">        self._check_tenant_network_types(cfg.CONF.ml2.tenant_network_types)</div><div class="line">        self._check_external_network_type(cfg.CONF.ml2.external_network_type)</div></pre></td></tr></table></figure>
<p>TypeManager对象中的drivers即为type driver对象。drivers根据/etc/neutron/plugins/ml2/ml2_conf.ini配置文件中的type_drivers参数去构造。在我的OpenStack环境中type_drivers参数值如下</p>
<p>type_drivers = vxlan,flat</p>
<p>两个driver对象的创建在TypeManager类的父类stevedore.named.NamedExtensionManager中完成。且创建两个对象被/stevedore/extension.py:Extension包裹。然后调用self._register_types()，将创建完成的typedriver对象register到self.drivers字典中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#/neutron/plugins/ml2/managers.py:TypeManager</span></div><div class="line"> <span class="function"><span class="keyword">def</span> <span class="title">_register_types</span><span class="params">(self)</span>:</span></div><div class="line">     <span class="keyword">for</span> ext <span class="keyword">in</span> self:</div><div class="line">         network_type = ext.obj.get_type()</div><div class="line">         <span class="keyword">if</span> network_type <span class="keyword">in</span> self.drivers:</div><div class="line">             LOG.error(_LE(<span class="string">"Type driver '%(new_driver)s' ignored because"</span></div><div class="line">                           <span class="string">" type driver '%(old_driver)s' is already"</span></div><div class="line">                           <span class="string">" registered for type '%(type)s'"</span>),</div><div class="line">                       &#123;<span class="string">'new_driver'</span>: ext.name,</div><div class="line">                        <span class="string">'old_driver'</span>: self.drivers[network_type].name,</div><div class="line">                        <span class="string">'type'</span>: network_type&#125;)</div><div class="line">         <span class="keyword">else</span>:</div><div class="line">             self.drivers[network_type] = ext</div><div class="line">     LOG.info(_LI(<span class="string">"Registered types: %s"</span>), self.drivers.keys())</div></pre></td></tr></table></figure>
<p>在register typedriver后，check tenant的network type是否在我们所register的type driver中，如果没有，则raise异常。其中tenant的network type是由/etc/neutron/plugins/ml2/ml2_conf.ini配置文件中的tenant_network_types参数设置。我的OpenStack环境的tenant_network_types参数配置如下:</p>
<p>tenant_network_types = vxlan</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># /neutron/plugins/ml2/managers.py:TypeManager</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_check_tenant_network_types</span><span class="params">(self, types)</span>:</span></div><div class="line">    self.tenant_network_types = []</div><div class="line">    <span class="keyword">for</span> network_type <span class="keyword">in</span> types:</div><div class="line">        <span class="keyword">if</span> network_type <span class="keyword">in</span> self.drivers:</div><div class="line">            self.tenant_network_types.append(network_type)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            LOG.error(_LE(<span class="string">"No type driver for tenant network_type: %s. "</span></div><div class="line">                          <span class="string">"Service terminated!"</span>), network_type)</div><div class="line">            <span class="keyword">raise</span> SystemExit(<span class="number">1</span>)</div><div class="line">    LOG.info(_LI(<span class="string">"Tenant network_types: %s"</span>), self.tenant_network_types)</div></pre></td></tr></table></figure>
<p>所以执行_check_tenant_network_types函数时，tenant network type校验成功。</p>
<p>mechanism_manager的创建也是类似的，它管理的mechanism driver。其根据/etc/neutron/plugins/ml2/ml2_conf.ini配置文件中的mechanism_drivers参数去构造mechanism driver对象。我的OpenStack环境mechanism_drivers配置参数如下:</p>
<p>mechanism_drivers = openvswitch,l2population</p>
<p>extension_manager的创建也类似。</p>
<p>extension_drivers = port_security</p>
<p>在type_manager，extension_manager和mechanism_manager创建完成后，执行initialize函数对所创建的driver进行初始化。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize</span><span class="params">(self)</span>:</span></div><div class="line">     <span class="comment"># Initialize each driver in the list.</span></div><div class="line">     <span class="keyword">for</span> driver <span class="keyword">in</span> self.ordered_ext_drivers:</div><div class="line">         LOG.info(_LI(<span class="string">"Initializing extension driver '%s'"</span>), driver.name)</div><div class="line">         driver.obj.initialize()</div></pre></td></tr></table></figure>
<p>从上可以看出，最终会调用type_manager所管理的driver的initialize函数。</p>
<p>注意：</p>
<p>PasteDeployment是一种机制或者说是一种设计模式，它用于在应用WSGI Application和Server提供一个联系的桥梁，并且为用户提供一个接口，当配置好PasteDeployment之后，用户只需调用loadapp方法就可以使用现有的WSGI Application，而保持了WSGIApplication对用户的透明性。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#/neutron/common/config.py</span></div><div class="line"> <span class="function"><span class="keyword">def</span> <span class="title">load_paste_app</span><span class="params">(app_name)</span>:</span></div><div class="line">   <span class="string">"""Builds and returns a WSGI app from a paste config file.</span></div><div class="line"></div><div class="line">   :param app_name: Name of the application to load</div><div class="line">   """</div><div class="line">   loader = wsgi.Loader(cfg.CONF)</div><div class="line">   app = loader.load_app(app_name)</div><div class="line">   <span class="keyword">return</span> app</div><div class="line"><span class="comment">#oslo_service/wsgi.py</span></div><div class="line"> <span class="function"><span class="keyword">def</span> <span class="title">load_app</span><span class="params">(self, name)</span>:</span></div><div class="line">       <span class="string">"""Return the paste URLMap wrapped WSGI application.</span></div><div class="line"></div><div class="line">       :param name: Name of the application to load.</div><div class="line">       :returns: Paste URLMap object wrapping the requested application.</div><div class="line">       :raises: PasteAppNotFound</div><div class="line"></div><div class="line">       """</div><div class="line">       <span class="keyword">try</span>:</div><div class="line">           LOG.debug(<span class="string">"Loading app %(name)s from %(path)s"</span>,</div><div class="line">                     &#123;<span class="string">'name'</span>: name, <span class="string">'path'</span>: self.config_path&#125;)</div><div class="line">           <span class="keyword">return</span> deploy.loadapp(<span class="string">"config:%s"</span> % self.config_path, name=name)</div><div class="line">       <span class="keyword">except</span> LookupError:</div><div class="line">           LOG.exception(_LE(<span class="string">"Couldn't lookup app: %s"</span>), name)</div><div class="line">           <span class="keyword">raise</span> PasteAppNotFound(name=name, path=self.config_path)</div></pre></td></tr></table></figure>
<p>run_wsgi_app()运行刚创建的应用。它首先实例化一个Server对象，然后调用start()方法将其启动,也即是<em>launch()方法。在传入的workers参数，</em>通过get_api_workers()获取，如果neutron.conf的api_workers没有配置，它会传入cpu数目的workers，达到最佳性能。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#/neutron/service.py </span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_wsgi_app</span><span class="params">(app)</span>:</span></div><div class="line">    server = wsgi.Server(<span class="string">"Neutron"</span>)</div><div class="line">    server.start(app, cfg.CONF.bind_port, cfg.CONF.bind_host,</div><div class="line">                 workers=_get_api_workers())</div><div class="line">    LOG.info(_LI(<span class="string">"Neutron service started, listening on %(host)s:%(port)s"</span>),</div><div class="line">             &#123;<span class="string">'host'</span>: cfg.CONF.bind_host, <span class="string">'port'</span>: cfg.CONF.bind_port&#125;)</div><div class="line">    <span class="keyword">return</span> server</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_get_api_workers</span><span class="params">()</span>:</span></div><div class="line">    workers = cfg.CONF.api_workers</div><div class="line">    <span class="keyword">if</span> workers <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">        workers = processutils.get_worker_count()</div><div class="line">    <span class="keyword">return</span> workers</div><div class="line"><span class="comment">#neutron/wsgi.py</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self, application, port, host=<span class="string">'0.0.0.0'</span>, workers=<span class="number">0</span>)</span>:</span></div><div class="line">        <span class="string">"""Run a WSGI server with the given application."""</span></div><div class="line">        self._host = host</div><div class="line">        self._port = port</div><div class="line">        backlog = CONF.backlog</div><div class="line"></div><div class="line">        self._socket = self._get_socket(self._host,</div><div class="line">                                        self._port,</div><div class="line">                                        backlog=backlog)</div><div class="line"></div><div class="line">        self._launch(application, workers)</div></pre></td></tr></table></figure>
<p>_launch()方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_launch</span><span class="params">(self, application, workers=<span class="number">0</span>)</span>:</span></div><div class="line">    service = WorkerService(self, application, self.disable_ssl)</div><div class="line">    <span class="keyword">if</span> workers &lt; <span class="number">1</span>:</div><div class="line">        <span class="comment"># The API service should run in the current process.</span></div><div class="line">        <span class="comment">#  workers小于1直接运行在当前的进程</span></div><div class="line">        self._server = service</div><div class="line">        <span class="comment"># Dump the initial option values</span></div><div class="line">        cfg.CONF.log_opt_values(LOG, logging.DEBUG)</div><div class="line">        service.start()</div><div class="line">        systemd.notify_once()</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="comment"># dispose the whole pool before os.fork, otherwise there will</span></div><div class="line">        <span class="comment"># be shared DB connections in child processes which may cause</span></div><div class="line">        <span class="comment"># DB errors.</span></div><div class="line">        api.dispose()</div><div class="line">        <span class="comment"># The API service runs in a number of child processes.</span></div><div class="line">        <span class="comment"># Minimize the cost of checking for child exit by extending the</span></div><div class="line">        <span class="comment"># wait interval past the default of 0.01s.</span></div><div class="line">        self._server = common_service.ProcessLauncher(cfg.CONF,</div><div class="line">                                                      wait_interval=<span class="number">1.0</span>)</div><div class="line">        self._server.launch_service(service, workers=workers)</div></pre></td></tr></table></figure>
      
    </div>

    <div>
      
        
<div id="wechat_subscriber" style="display: block; padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/uploads/1.jpg" alt="Luckylau wechat" style="width: 200px; max-width: 100%;"/>
    <div>如果对您有价值,看官可以打赏的！</div>
</div>


      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/neutron源码/" rel="tag"># neutron源码</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/02/27/neutron架构/" rel="next" title="neutron架构">
                <i class="fa fa-chevron-left"></i> neutron架构
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2017/02/28/python的wsgi理解/" rel="prev" title="Python的wsgi理解">
                Python的wsgi理解 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

          
          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/logo.jpg"
               alt="Luckylau" />
          <p class="site-author-name" itemprop="name">Luckylau</p>
          <p class="site-description motion-element" itemprop="description">人生识字忧患始</p>
        </div>
        <nav class="site-state motion-element">
        
          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">54</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">8</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">13</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/Luckylau" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://weibo.com/2606534415/profile?topnav=1&wvr=6&is_all=1" target="_blank" title="Weibo">
                  
                    <i class="fa fa-fw fa-weibo"></i>
                  
                  Weibo
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Luckylau</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

<div class="busuanzi-count">

  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv"><i class="fa fa-user"></i><span class="busuanzi-value" id="busuanzi_value_site_uv"></span></span>
  

  
    <span class="site-pv"><i class="fa fa-eye"></i><span class="busuanzi-value" id="busuanzi_value_site_pv"></span></span>
  
  
</div>



        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  



  




	





  





  

  
      <!-- UY BEGIN -->
      <script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid="></script>
      <!-- UY END -->
  




  
  
  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length == 0) {
      search_path = "search.xml";
    }
    var path = "/" + search_path;
    // monitor main search box;

    function proceedsearch() {
      $("body").append('<div class="popoverlay">').css('overflow', 'hidden');
      $('.popup').toggle();
    }
    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';
      $.ajax({
        url: path,
        dataType: "xml",
        async: true,
        success: function( xmlResponse ) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = $( "entry", xmlResponse ).map(function() {
            return {
              title: $( "title", this ).text(),
              content: $("content",this).text(),
              url: $( "url" , this).text()
            };
          }).get();
          var $input = document.getElementById(search_id);
          var $resultContent = document.getElementById(content_id);
          $input.addEventListener('input', function(){
            var matchcounts = 0;
            var str='<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length > 1) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var content_index = [];
                var data_title = data.title.trim().toLowerCase();
                var data_content = data.content.trim().replace(/<[^>]+>/g,"").toLowerCase();
                var data_url = decodeURIComponent(data.url);
                var index_title = -1;
                var index_content = -1;
                var first_occur = -1;
                // only match artiles with not empty titles and contents
                if(data_title != '') {
                  keywords.forEach(function(keyword, i) {
                    index_title = data_title.indexOf(keyword);
                    index_content = data_content.indexOf(keyword);
                    if( index_title >= 0 || index_content >= 0 ){
                      isMatch = true;
                      if (i == 0) {
                        first_occur = index_content;
                      }
                    }

                  });
                }
                // show search results
                if (isMatch) {
                  matchcounts += 1;
                  str += "<li><a href='"+ data_url +"' class='search-result-title'>"+ data_title +"</a>";
                  var content = data.content.trim().replace(/<[^>]+>/g,"");
                  if (first_occur >= 0) {
                    // cut out 100 characters
                    var start = first_occur - 20;
                    var end = first_occur + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if(start == 0){
                      end = 50;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    var match_content = content.substring(start, end);
                    // highlight all keywords
                    keywords.forEach(function(keyword){
                      var regS = new RegExp(keyword, "gi");
                      match_content = match_content.replace(regS, "<b class=\"search-keyword\">"+keyword+"</b>");
                    });

                    str += "<p class=\"search-result\">" + match_content +"...</p>"
                  }
                  str += "</li>";
                }
              })};
            str += "</ul>";
            if (matchcounts == 0) { str = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>' }
            if (keywords == "") { str = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>' }
            $resultContent.innerHTML = str;
          });
          proceedsearch();
        }
      });}

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched == false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(function(e){
      $('.popup').hide();
      $(".popoverlay").remove();
      $('body').css('overflow', '');
    });
    $('.popup').click(function(e){
      e.stopPropagation();
    });
  </script>


  

  

  

  


</body>
</html>
